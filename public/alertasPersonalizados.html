<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./script/sideBar.js"></script>
    <link rel="stylesheet" href="./style/alertaPersonalizado.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Konkhmer+Sleokchher&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap ">

    <title>Alertas personalizados</title>
</head>

<body>
    <side-Bar></side-Bar>
    <main>
        <header class="header">
            <div class="title">Alertas Personalizados</div>
            <div class="btn">
                <button id="btn_notificacao" class="btn_sino" onclick="notificacao()">
                    <img src="img/notification-bell.png" alt="Notificacoes">
                </button>
                <span id="span_bem_vindo"></span>
            </div>
        </header>

        <div class="conteudo-principal">

            <p class="descricao">Aqui voc√™ pode ver seus alertas personalizados criados, edit√°-los ou criar novos</p>

            <section class="novo-alerta">
                <p><strong>Adicionar um novo alerta</strong></p>
                <div id="btnAddAlerta" class="add-card">+</div>
            </section>

            <section class="lista-alertas">
                <h3>Seus Alertas Personalizados:</h3>
                <div class="cards" id="listaAlertas">
                    <!-- os cards vao ser gerados aqui -->
                    </div>
            </section>
        </div>
    </main>

    <!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
      <h2>Alerta Personalizado</h2>

      <label for="nomeAlerta">Nome do Alerta</label>
      <input type="text" id="nomeAlerta" placeholder="Ex: Fraudes acima de 300 em S√£o Paulo">

      <div class="regras">
          <label>Regras do Alerta</label>

          <p>Me alertar quando o valor for maior que</p>
          <input type="number" id="valorMinimo" placeholder="R$">

          <p>M√©todo de pagamento (opcional)</p>
    <input type="text" id="metodoPagamento" placeholder="Ex: Cr√©dito ou D√©bito">

          <p>Filtrar por cidade (opcional)</p>
          <input type="text" id="cidadeAlerta" placeholder="Ex: S√£o Paulo">

          <p>Filtrar por m√™s (opcional, 1‚Äì12)</p>
          <input type="number" id="mesAlerta" min="1" max="12" placeholder="Ex: 12">

          <p>Filtrar por ano (opcional)</p>
          <input type="number" id="anoAlerta" placeholder="Ex: 2022">

          <div style="margin-top: 10px;">
              <input type="checkbox" id="ativoAlerta" checked>
              <label for="ativoAlerta">Alerta ativo</label>
          </div>
      </div>

      <div class="modal-actions">
          <button id="btnCancelar" class="cancelar">Cancelar</button>
          <button id="btnCriarAlerta" class="criar">Criar Alerta</button>
      </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function swalSucesso(titulo, mensagem) {
        return Swal.fire({
            icon: 'success',
            title: titulo || 'Sucesso',
            text: mensagem || '',
            confirmButtonColor: '#3085d6'
        });
    }

    function swalErro(titulo, mensagem) {
        return Swal.fire({
            icon: 'error',
            title: titulo || 'Erro',
            text: mensagem || '',
            confirmButtonColor: '#d33'
        });
    }

    function swalInfo(titulo, mensagem) {
        if (mensagem === undefined) {
            mensagem = titulo;
            titulo = 'Informa√ß√£o';
        }

        return Swal.fire({
            icon: 'info',
            title: titulo || 'Informa√ß√£o',
            text: mensagem || '',
            confirmButtonColor: '#3085d6'
        });
    }

    async function swalConfirmar(titulo, mensagem) {
        const confirmar = await Swal.fire({
            title: titulo || 'Tem certeza?',
            text: mensagem || '',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6'
        });

        return confirmar.isConfirmed;
    }

    span_bem_vindo.innerHTML = `Bem vindo(a), ${sessionStorage.NOME_USUARIO}!`;

    const btnAdd = document.getElementById("btnAddAlerta");
    const modal = document.getElementById("modal");
    const btnCancelar = document.getElementById("btnCancelar");
    const btnCriarAlerta = document.getElementById("btnCriarAlerta");
    let alertasCarregados = [];
    let alertaEmEdicaoId = null;

    let slackNotificationsEnabled = JSON.parse(localStorage.getItem("slackNotificationsEnabled") || "true");

    function atualizarIconeSlack() {
        const botao = document.getElementById("btn_notificacao");

        if (slackNotificationsEnabled) {
            botao.style.opacity = "1";
            botao.title = "Notifica√ß√µes do Slack: Ligadas";
        } else {
            botao.style.opacity = "0.3";
            botao.title = "Notifica√ß√µes do Slack: Desligadas";
        }
    }

    function notificacao() {
        slackNotificationsEnabled = !slackNotificationsEnabled;

        localStorage.setItem("slackNotificationsEnabled", JSON.stringify(slackNotificationsEnabled));

        atualizarIconeSlack();

        const usuario = sessionStorage.NOME_USUARIO;
        let mensagem = "";

        if (slackNotificationsEnabled) {
            mensagem = "üîî Notifica√ß√µes do Slack ATIVADAS pelo usu√°rio " + usuario + ".";
        } else {
            mensagem = "üîî Notifica√ß√µes do Slack DESATIVADAS pelo usu√°rio " + usuario + ".";
        }

        const idEmpresa = sessionStorage.ID_EMPRESA;

        fetch("/slack/status/" + idEmpresa, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ativo: slackNotificationsEnabled })
        }).catch(erro => {
            console.error("Erro ao atualizar status do Slack no backend:", erro);
        });

        enviarNotificacaoSlack(mensagem, true);
    }

    window.addEventListener("load", async () => {
        const idEmpresa = sessionStorage.ID_EMPRESA;

        try {
            const resposta = await fetch("/slack/status/" + idEmpresa);
            if (resposta.ok) {
                const dados = await resposta.json();
                slackNotificationsEnabled = dados.ativo;
                localStorage.setItem("slackNotificationsEnabled", JSON.stringify(slackNotificationsEnabled));
            } else {
                console.error("erro ao buscar status do slack no backend.");
                slackNotificationsEnabled = JSON.parse(localStorage.getItem("slackNotificationsEnabled") || "true");
            }
        } catch (erro) {
            console.error("Erro ao buscar status do slack no backend", erro);
            slackNotificationsEnabled = JSON.parse(localStorage.getItem("slackNotificationsEnabled") || "true");
        }

        atualizarIconeSlack();
        carregarAlertas();
    });

    async function enviarNotificacaoSlack(texto, ignorarEstado = false) {

        if (!ignorarEstado && !slackNotificationsEnabled) {
            console.log("Slack desligado. Notifica√ß√£o n√£o ser√° enviada.");
            return;
        }

        try {
            const resposta = await fetch("/slack/notificar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: texto })
            });

            if (!resposta.ok) {
                console.error("Erro ao enviar notifica√ß√µes para o Slack:", resposta.status);
            }
        } catch (erro) {
            console.error("Erro ao enviar notifica√ß√£o:", erro);
        }
    }

    // Mostrar modal
    btnAdd.addEventListener("click", () => {
        alertaEmEdicaoId = null;
        limparCamposModal();
        document.querySelector("#modal h2").textContent = "Alerta personalizado";
        document.getElementById("btnCriarAlerta").textContent = "Criar alerta";
        
        modal.classList.add("active");
    });

    // Fechar modal ao clicar em "Cancelar"
    btnCancelar.addEventListener("click", () => {
        modal.classList.remove("active");
    });

    // Fechar modal ao clicar fora do conte√∫do
    modal.addEventListener("click", (e) => {
        if (e.target === modal) {
            modal.classList.remove("active");
        }
    });

    btnCriarAlerta.addEventListener("click", async () => {
        const nomeAlerta = document.getElementById("nomeAlerta").value.trim();
        const valorMinimoAl = document.getElementById("valorMinimo").value.trim();
        const metodoPagamentoAl = document.getElementById("metodoPagamento").value.trim();
        const cidade = document.getElementById("cidadeAlerta").value.trim();
        const mesAl = document.getElementById("mesAlerta").value.trim();
        const anoAl = document.getElementById("anoAlerta").value.trim();
        const ativoAl = document.getElementById("ativoAlerta").checked;

        const idEmpresa = sessionStorage.ID_EMPRESA;
        const idUsuario = sessionStorage.ID_USUARIO;

        if (!nomeAlerta) {
            await swalInfo("Campo obrigat√≥rio", "Informe um nome para o alerta");
            return;
        }

        const valorMinimo = valorMinimoAl ? Number(valorMinimoAl) : null;
        const mes = mesAl ? Number(mesAl) : null;
        const ano = anoAl ? Number(anoAl) : null;

        const dados = {
            idEmpresa,
            idUsuario,
            nomeAlerta,
            metodoPagamento: metodoPagamentoAl || null,
            valorMinimo,
            cidade: cidade || null,
            mes,
            ano,
            ativo: ativoAl
        };

        const criando = (alertaEmEdicaoId == null);
        const url = criando ? "/alertaPersonalizado" : `/alertaPersonalizado/atualizar/${alertaEmEdicaoId}`;

        try {
            const resposta = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(dados)
            });

            if (!resposta.ok) {
                const corpo = await resposta.text();
                console.error("Erro ao cadastrar alerta.", corpo);
                await swalErro("Erro", "Erro ao criar alerta.");
                return;
            }

            await swalSucesso("Sucesso", criando ? "Alerta criado com sucesso." : "Alerta atualizado com sucesso.");
            modal.classList.remove("active");

            limparCamposModal();
            alertaEmEdicaoId = null;

            document.getElementById("nomeAlerta").value = "";
            document.getElementById("valorMinimo").value = "";
            document.getElementById("cidadeAlerta").value = "";
            document.getElementById("mesAlerta").value = "";
            document.getElementById("anoAlerta").value = "";
            document.getElementById("ativoAlerta").checked = true;

            carregarAlertas();
        } catch (erro) {
            console.error("Erro na req para criar alerta", erro);
            await swalInfo("Erro na comunica√ß√£o com o servidor");
        }
    });

    function montarDescricaoAlerta(alerta) {
        let partes = [];

        // essas variaveis em snake-case vem do sql

        if (alerta.valor_minimo != null) {
            partes.push(`valor ‚â• R$ ${Number(alerta.valor_minimo).toFixed(2)}`);
        }

        if (alerta.metodo_pagamento) {
            partes.push(`m√©todo = ${alerta.metodo_pagamento}`);
        }

        if (alerta.cidade) {
            partes.push(`cidade = ${alerta.cidade}`);
        }

        if (alerta.mes != null) {
            partes.push(`m√™s = ${alerta.mes}`);
        }

        if (alerta.ano != null) {
            partes.push(`ano = ${alerta.ano}`);
        }

        if (partes.length == 0) {
            return "Sem filtros (todas as informa√ß√µes)";
        }

        return partes.join("<br>");
    }

    async function carregarAlertas() {
    const listaAlertasDiv = document.getElementById("listaAlertas");
    const idEmpresa = sessionStorage.ID_EMPRESA;

    listaAlertasDiv.innerHTML = `<p style="color: #777;">Carregando alertas...</p>`;

    try {
        const resposta = await fetch(`/alertaPersonalizado/empresa/${idEmpresa}`);

        if (!resposta.ok) {
            console.error("Erro ao buscar os alertas:", resposta.status);
            listaAlertasDiv.innerHTML = `<p style="color: red;">Erro ao carregar alertas</p>`;
            return;
        }

        const alertas = await resposta.json();

        alertasCarregados = alertas;

        if (!alertas || alertas.length === 0) {
            listaAlertasDiv.innerHTML = `<p style="color: #777;">Voc√™ ainda n√£o criou nenhum alerta</p>`;
            return;
        }

        listaAlertasDiv.innerHTML = "";

        alertas.forEach(alerta => {
            const card = document.createElement("div");
            card.className = "alerta-card";

            const descricaoFiltros = montarDescricaoAlerta(alerta);
            const statusTexto = alerta.ativo ? "Ativo" : "Inativo";

            card.innerHTML = `
                <div class="card-header">
                    <span>${statusTexto}</span>
                    <span class="icon">üîî</span>
                </div>
                <p class="alerta-titulo">${alerta.nome_alerta}</p>
                <p class="alerta-descricao">${descricaoFiltros}</p>
                <div class="botoes-alerta">
                    <button onclick="exibirAlerta(${alerta.id_alerta})">Exibir</button>
                    <button onclick="editarAlerta(${alerta.id_alerta})">Modificar</button>
                    <button onclick="excluirAlerta(${alerta.id_alerta})">Excluir</button>
                </div>
            `;

            listaAlertasDiv.appendChild(card);
        });
    } catch (erro) {
        console.error("Erro ao carregar os alertas", erro);
        listaAlertasDiv.innerHTML = `<p style="color: red;">Erro ao carregar alertas.</p>`;
    }
}


    function exibirAlerta(idAlerta) {
        const id = Number(idAlerta);

        const alerta = alertasCarregados.find(al => al.id_alerta == id);

        if(!alerta) {
            swalErro("Alerta n√£o encontrado na lista");
            return;
        }

        const statusTexto = alerta.ativo ? "Ativo" : "Inativo";
        const descricaoFiltros = montarDescricaoAlerta(alerta);

        const mensagem =
        `Status: ${statusTexto}\n` +
        `Filtros: ${descricaoFiltros}`;

    swalInfo(`üìù ${alerta.nome_alerta}`, mensagem);

    }

    function editarAlerta(idAlerta) {
        const id = Number(idAlerta);

        const alerta = alertasCarregados.find(al => al.id_alerta == id);

        if(!alerta){
            swalErro("Erro", "Alerta n√£o encontrado na lista");
            return;
        }

        alertaEmEdicaoId = id;

        document.getElementById("nomeAlerta").value = alerta.nome_alerta || "";
        document.getElementById("valorMinimo").value = alerta.valor_minimo != null ? alerta.valor_minimo : "";
        document.getElementById("metodoPagamento").value = alerta.metodo_pagamento || "";
        document.getElementById("cidadeAlerta").value = alerta.cidade || "";
        document.getElementById("mesAlerta").value = alerta.mes != null ? alerta.mes : "";
        document.getElementById("anoAlerta").value = alerta.ano != null ? alerta.ano : "";
        document.getElementById("ativoAlerta").checked = alerta.ativo == 1 || alerta.ativo == true;

        document.querySelector("#modal h2").textContent = "Editar alerta";
        document.getElementById("btnCriarAlerta").textContent = "Salvar altera√ß√µes";

        modal.classList.add("active");
        }

    function limparCamposModal() {
    document.getElementById("nomeAlerta").value = "";
    document.getElementById("valorMinimo").value = "";
    document.getElementById("metodoPagamento").value = "";
    document.getElementById("cidadeAlerta").value = "";
    document.getElementById("mesAlerta").value = "";
    document.getElementById("anoAlerta").value = "";
    document.getElementById("ativoAlerta").checked = true;
}

    async function excluirAlerta(idAlerta) {

    const id = Number(idAlerta);

    const confirmado = await swalConfirmar("Tem certeza?", "Essa a√ß√£o n√£o poder√° ser desfeita.");

    if (!confirmado) {
        return;
    }

    const idEmpresa = sessionStorage.ID_EMPRESA;

    try {
        const resposta = await fetch(`/alertaPersonalizado/excluir/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({idEmpresa})
        });
        if (!resposta.ok) {
            const corpo = await resposta.text();
            console.error("Erro ao excluir o alerta", corpo);

            await swalErro("Erro", "Erro ao excluir alerta.");
            return;
        }

        await swalSucesso("Exclu√≠do!", "O alerta foi exclu√≠do com sucesso.");
        carregarAlertas();

    } catch (erro) {
        console.error("Erro na req ao tentar excluir o alerta", erro);
        await swalErro("Erro", "Erro na comunica√ß√£o com o servidor.");
    }
}
</script>
</body>
</html>