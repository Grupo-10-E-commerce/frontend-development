<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./script/sideBar.js"></script>
    <link rel="stylesheet" href="./style/centralAnaliseFraude.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Konkhmer+Sleokchher&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap ">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <title>Central de an√°lise de fraude</title>
</head>

<body>
    <side-Bar></side-Bar>
    <div class="header">
        <div class="title">Central de an√°lise de fraude</div>
        <div class="btn">
            <button id="btn_relatorio" class="btn_emitir_relatorio" onclick="emitirRelatorio()">Emitir
                Relat√≥rio</button>
            <button id="btn_notificacao" class="btn_sino" onclick="notificacao()">
                <img src="img/notification-bell.png" alt="Notificacoes">
            </button>
            <span id="span_bem_vindo"></span>
        </div>
    </div>

    <main class="container">
        <section class="top-cards">
            <div class="card">
                <p class="titulo">N¬∫ de Fraudes</p>
                <div class="valor">127</div>
                <div class="icone">‚ö†Ô∏è</div>
            </div>
            <div class="card">
                <p class="titulo">Porcentagem de Fraudes</p>
                <div class="valor">24%</div>
                <p class="sub">Em rela√ß√£o a 528 Vendas</p>
                <div class="icone">‚ö†Ô∏è</div>
            </div>
                <div class="grafico-card">
                    <h3>Fraudes por Regi√£o</h3>
                    <img src="./img/grafico-regiao.png" alt="">
                    <div class="legenda">
                        <span class="cor roxo"></span> Muitas Fraudes
                        <span class="cor claro"></span> Poucas Fraudes
                    </div>
                </div>

                <div class="alertas">
                    <h3>√öltimos alertas de Fraude</h3>
                    <div class="alerta">
                        ‚ö†Ô∏è <strong>Cuidado! Poss√≠vel fraude</strong><br>√Äs 23:55 horas
                    </div>
                    <div class="alerta">
                        ‚ö†Ô∏è <strong>Cuidado! Poss√≠vel fraude</strong><br>√Äs 23:58 horas
                    </div>
                    <div class="alerta">
                        ‚ö†Ô∏è <strong>Cuidado! Poss√≠vel fraude</strong><br>√Äs 03:00 horas
                    </div>
                    <div class="alerta">
                        ‚ö†Ô∏è <strong>Cuidado! Poss√≠vel fraude</strong><br>√Äs 18:25 horas
                    </div>
                </div>
        </section>


        <section class="conteudo">
            <div class="left">
                <div class="compras-card">
                    <h3>Lista de Compras Suspeitas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Compras</th>
                                <th>Data</th>
                                <th>Valores</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ID 01934209<br></td>
                                <td>01/01/25</td>
                                <td>R$800</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 08926543<br></td>
                                <td>03/01/25</td>
                                <td>R$1000</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 08354678<br></td>
                                <td>13/01/25</td>
                                <td>R$900</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 06273849<br></td>
                                <td>25/01/25</td>
                                <td>R$850</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 09337731<br></td>
                                <td>04/02/25</td>
                                <td>R$950</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 02738491<br></td>
                                <td>05/02/25</td>
                                <td>R$850</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                            <tr>
                                <td>ID 01845620<br></td>
                                <td>16/02/25</td>
                                <td>R$900</td>
                                <td><button>Ver Mais</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="grafico-card-bar">
                <h3>Distribui√ß√£o de Fraudes</h3>
                <div id="barChart"></div>
            </div>


            </div>
        </section>
    </main>

</body>

</html>
<script>
    span_bem_vindo.innerHTML = `Bem vindo(a), ${sessionStorage.NOME_USUARIO}!`;

    // Gr√°fico de Fraudes por Regi√£o (Mapa)
    var mapOptions = {
        chart: {
            type: 'heatmap',
            height: 250
        },
        dataLabels: { enabled: false },
        series: [{
            name: 'Fraudes',
            data: [
                { x: 'Sul', y: 10 },
                { x: 'Sudeste', y: 40 },
                { x: 'Centro-Oeste', y: 20 },
                { x: 'Nordeste', y: 30 },
                { x: 'Norte', y: 15 }
            ]
        }],
        colors: ['#5c4df5'],
        title: { text: '' },
    };
    new ApexCharts(document.querySelector("#mapChart"), mapOptions).render();

    // Gr√°fico de Barras ‚Äî Distribui√ß√£o de Fraudes
    var barOptions = {
        chart: {
            type: 'bar',
            height: 300,
            toolbar: {
                show: false  
            }
        }, 
        series: [{
            name: 'Fraudes',
            data: [15, 25, 22, 20, 18]
        }],
        dataLabels: {
                enabled: true,
                style: {
                    fontSize: '18px',
                    fontWeight: 'bolder',
                    colors: ['#fff'], 
                },
            },
        plotOptions: {
                bar: {
                columnWidth: '70%', 
                dataLabels: {
                    position: 'top',
                }
                }
            },
        xaxis: {
            categories: ['Cart√£o de Cr√©dito', 'Identidade Falsa', 'ChargeBack', 'Fraude Amig√°vel', 'Outro'],
            labels: {
            style: {
                    colors: '#333',
                    fontSize: '13px'
            }
        }
        },
        yaxis: {
        labels: {
            style: {
                colors: '#333',
                fontSize: '13px'
            }
        }
    },
        colors: ['#a48bff'],
    };
    new ApexCharts(document.querySelector("#barChart"), barOptions).render();

    let slackNotificationsEnabled = JSON.parse(localStorage.getItem("slackNotificationsEnabled") || "true");

    function atualizarIconeSlack() {
        const botao = document.getElementById("btn_notificacao");

        if(slackNotificationsEnabled) {
            botao.style.opacity = "1";
            botao.title = "Notifica√ß√µes do Slack: Ligadas";
        } else {
            botao.style.opacity = "0.3";
            botao.title = "Notifica√ß√µes do Slack: Desligadas";
        }
    }

    function notificacao(){
        slackNotificationsEnabled = !slackNotificationsEnabled;

        localStorage.setItem("slackNotificationsEnabled", JSON.stringify(slackNotificationsEnabled));

        atualizarIconeSlack();

        const usuario = sessionStorage.NOME_USUARIO;
        let mensagem = "";

        if(slackNotificationsEnabled) {
            mensagem = "üîî Notifica√ß√µes do Slack ATIVADAS pelo usu√°rio " + usuario + ".";
        } else {
            mensagem = "üîî Notifica√ß√µes do Slack DESATIVADAS pelo usu√°rio " + usuario + ".";
        }

        enviarNotificacaoSlack(mensagem, true);
    }

    window.addEventListener("load", atualizarIconeSlack);

    async function enviarNotificacaoSlack(texto, ignorarEstado = false) {

        if (!ignorarEstado && !slackNotificationsEnabled) {
        console.log("Slack desligado. Notifica√ß√£o n√£o ser√° enviada.");
        return;
    }

        try {
            const resposta = await fetch("/slack/notificar", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({text: texto})
            });

            if(!resposta.ok) {
                console.error("Erro ao enviar notifica√ß√µes para o Slack:", resposta.status);
            }
        } catch (erro) {
            console.error("Erro ao enviar notifica√ß√£o:", erro);
        }
    }
</script>